BITS 32;
org 0x3800;
;Keyboard IRQ(0)

strt equ 0xFFF;
fin equ 0xFEB;

start:

push eax;
push ebx;
push ecx;
push edx;

in al, 0x60;

mov bl, al;

in      al, 0x61
mov     ah, al
or      al, 0x80
out     0x61, al
mov     al, ah
out     0x61, al

mov al, bl;

add al, 0x80;

cmp al, 0x0;
jge loop2;

sub al, 0x80;

mov edx, fin;

loop0:

cmp edx, strt;
je loop1;

cmp byte [edx], al;
je stop;

inc edx;

jmp loop0;

loop1:

mov edx, fin;

.loop:

cmp edx, strt;
je stop;

cmp byte [edx], 0x0;
je .true;

inc edx;

jmp .loop;

.true:

mov byte [edx], al;

jmp stop;

loop2:

mov edx, fin;

.loop:

cmp edx, strt;
je stop;

cmp byte [edx], al;
je loop3;

inc edx;

jmp .loop;

loop3:

mov edx, fin;

.loop:

cmp edx, strt;
je stop;

cmp byte [edx], al;
je .true;

inc edx;

jmp .loop;

.true:

mov byte [edx], 0x0;

jmp loop4;


loop4:

cmp al, 0x1;
je closeW;

mov edx, fin;
sub al, 0x80;

.loop:

cmp edx, strt;
je stop;

cmp byte [edx], al;
je .true;

inc edx;

jmp .loop;

.true:

mov byte [edx], 0x0;

jmp stop;

stop:

mov al, 0x20;
out 0x20, al;
;out 0xA0, al;

pop edx;
pop ecx;
pop ebx;
pop eax;

iretd;

closeW:

pop edx;
pop ecx;
pop ebx;
pop eax;

pop edi;
push edi;

cmp edi, 0xF00000;
jl .ex1;

push eax;
push ebx;
push ecx;
push edx;

mov dword [0xFCD], 0x30;

;jmp .ex;--------------------------

mov eax, 0xF00000;

.loop:

cmp eax, 0xFFFFFD;
jge .ex;

mov byte [eax], 0x0;

inc eax;

jmp .loop;

.ex:

mov eax, edi;

;mov edx, edi;
;mov eax, 0xE00000;
;mov dword [eax], edx;

mov ebx, eax;
add ebx, 0x88;
mov edx, prog;

;jmp .ex0;---------------------------

.loop0:

cmp eax, ebx;
jge .ex0;

mov cl, [edx];
mov byte [eax], cl;

inc eax;
inc edx;

jmp .loop0;

.ex0:

pop edx;
pop ecx;
pop ebx;
pop eax;

.ex1:

push eax;

mov al, 0x20;
out 0x20, al;
;out 0xA0, al;

pop eax;

iretd;

prog db 0x55, 0x89, 0xE5, 0x83, 0xE4, 0xF0, 0xE8, 0x19, 0x00, 0x00, 0x00, 0x05, 0x71, 0x00, 0x00, 0x00, 0x8B, 0x90, 0xFC, 0xFF, 0xFF, 0xFF, 0xC6, 0x02, 0x30, 0x8B, 0x80, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xD0, 0x90, 0xC9, 0xC3, 0x8B, 0x04, 0x24, 0xC3, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x7A, 0x52, 0x00, 0x01, 0x7C, 0x08, 0x01, 0x1B, 0x0C, 0x04, 0x04, 0x88, 0x01, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 0xB8, 0xFF, 0xFF, 0xFF, 0x24, 0x00, 0x00, 0x00, 0x00, 0x41, 0x0E, 0x08, 0x85, 0x02, 0x42, 0x0D, 0x05, 0x60, 0xC5, 0x0C, 0x04, 0x04, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0xBC, 0xFF, 0xFF, 0xFF, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xE6, 0x0F;
